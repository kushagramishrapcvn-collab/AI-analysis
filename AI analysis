import streamlit as st
from google import genai
import fitz  # PyMuPDF
import os
import uuid

# --- 1. CONFIGURATION ---
st.set_page_config(page_title="Logic-Aware PDF Editor", layout="wide", page_icon="ðŸŽ¯")
st.title("ðŸ¤– Intelligent & Layout-Preserving PDF Editor")

# CSS to make the interface look cleaner
st.markdown("""
    <style>
    .stRadio [role=radiogroup]{flex-direction:row;}
    .stButton>button {width: 100%; border-radius: 5px; height: 3em; background-color: #007bff; color: white;}
    </style>
    """, unsafe_allow_html=True)

try:
    API_KEY = st.secrets["GEMINI_API_KEY"]
    client = genai.Client(api_key=API_KEY)
except Exception:
    st.error("Missing GEMINI_API_KEY in Streamlit Secrets!")
    st.stop()

# --- 2. THE UI ---
uploaded_file = st.file_uploader("Step 1: Upload Original PDF (Marksheet/Math Notes)", type="pdf")

col1, col2 = st.columns(2)
with col1:
    target_text = st.text_input("Step 2: Text to change", placeholder="e.g. 66")
with col2:
    new_instruction = st.text_input("Step 3: New value/instruction", placeholder="e.g. 76")

# THE TWO OPTIONS
mode = st.radio(
    "Step 4: Select Editing Mode",
    ["Edit & Keep Format (Single Change)", "Analyse & Change Related Logic (Smart)"],
    help="Smart mode automatically recalculates totals and dependent math."
)

if st.button("Execute Intelligent Edit"):
    if uploaded_file and target_text:
        with st.spinner("Analyzing document logic and preserving symmetry..."):
            # Create a unique filename for multiuser safety
            session_id = str(uuid.uuid4())
            input_path = f"input_{session_id}.pdf"
            output_path = f"output_{session_id}.pdf"
            
            with open(input_path, "wb") as f:
                f.write(uploaded_file.getbuffer())
            
            doc = fitz.open(input_path)
            
            # --- LOGIC ENGINE ---
            if "Smart" in mode:
                full_text = "\n".join([page.get_text() for page in doc])
                prompt = f"""
                You are a mathematical auditor. Document content: {full_text}
                The user is changing '{target_text}' to '{new_instruction}'.
                Identify all dependent numbers (Totals, Percentages, Calculations).
                Return ONLY the pairs in this format: Old -> New | Old -> New.
                No conversational text.
                """
            else:
                prompt = f"Change '{target_text}' to '{new_instruction}'. Return ONLY the result."

            try:
                response = client.models.generate_content(model='gemini-2.0-flash', contents=prompt)
                ai_logic = response.text.strip()

                # Parse changes
                changes = []
                if "Smart" in mode and "->" in ai_logic:
                    pairs = ai_logic.split("|")
                    for p in pairs:
                        if "->" in p:
                            o, n = p.split("->")
                            changes.append((o.strip(), n.strip()))
                else:
                    changes.append((target_text, ai_logic))

                # --- APPLY SURGICAL EDITS ---
                changes_applied = 0
                for old_val, new_val in changes:
                    for page in doc:
                        instances = page.search_for(old_val)
                        for inst in instances:
                            # 1. Whitening strictly in margin
                            page.add_redact_annot(inst, fill=(1, 1, 1))
                            page.apply_redactions()
                            
                            # 2. Baseline Alignment (-2) to prevent '6' falling below
                            # inst.tl is Top-Left, inst.y1 is Bottom-Edge
                            point = fitz.Point(inst.x0, inst.y1 - 2)
                            
                            page.insert_text(
                                point, 
                                new_val, 
                                fontsize=10, 
                                fontname="helv", 
                                color=(0, 0, 0)
                            )
                            changes_applied += 1

                if changes_applied > 0:
                    doc.save(output_path)
                    with open(output_path, "rb") as f:
                        st.success(f"Successfully applied {changes_applied} logical updates!")
                        st.download_button("Download Edited PDF", f, file_name="edited_logic.pdf")
                else:
                    st.error(f"Could not find '{target_text}' in the PDF.")

            except Exception as e:
                st.error(f"AI Error: {e}")
            
            # Cleanup temp files
            doc.close()
            if os.path.exists(input_path): os.remove(input_path)
            if os.path.exists(output_path): os.remove(output_path)
    else:
        st.warning("Please upload a file and specify text to change.")
