import streamlit as st
from google import genai
import fitz  # PyMuPDF
import os
import uuid

# --- 1. SETTINGS & AI SETUP ---
st.set_page_config(page_title="Logic-Aware PDF Editor", layout="wide", page_icon="âš–ï¸")

if "GEMINI_API_KEY" not in st.secrets:
    st.error("Missing API Key! Please add 'GEMINI_API_KEY' to your Streamlit Secrets.")
    st.stop()

client = genai.Client(api_key=st.secrets["GEMINI_API_KEY"])

st.title("ðŸŽ¯ Smart Symmetry PDF Editor")
st.subheader("Edit math values and let AI handle the logic.")

# --- 2. USER INTERFACE ---
with st.sidebar:
    st.info("This app preserves your PDF layout exactly while updating mathematical dependencies.")
    mode = st.radio(
        "Editing Mode",
        ["Edit & Keep Format (Surgical)", "Analyse & Change Related Logic (Smart)"],
        help="Smart mode finds Totals, Percentages, and Derivatives and updates them automatically."
    )

uploaded_file = st.file_uploader("Upload PDF", type="pdf")

col1, col2 = st.columns(2)
with col1:
    target_text = st.text_input("Original value (e.g., 66)", placeholder="Text to find")
with col2:
    new_val = st.text_input("New value/instruction (e.g., 76)", placeholder="Text to insert")

# --- 3. PROCESSING ENGINE ---
if st.button("Apply Smart Edits"):
    if uploaded_file and target_text:
        with st.spinner("Analyzing math logic and whitening margins..."):
            # Multiuser unique IDs
            uid = str(uuid.uuid4())[:8]
            in_path = f"in_{uid}.pdf"
            out_path = f"out_{uid}.pdf"
            
            with open(in_path, "wb") as f:
                f.write(uploaded_file.getbuffer())
            
            doc = fitz.open(in_path)
            
            # --- AI LOGIC STEP ---
            if "Smart" in mode:
                # Read all text for Data 1 (Calculus/Trigonometry/Marksheet) context
                context = "\n".join([p.get_text() for p in doc])
                prompt = f"""
                Context: {context}
                User is changing '{target_text}' to '{new_val}'.
                Calculate all dependent mathematical changes (Totals, %, Results).
                Return ONLY pairs in this format: {target_text} -> {new_val} | OldVal -> NewVal
                No other text.
                """
            else:
                prompt = f"Change '{target_text}' to '{new_val}'. Return ONLY the result."

            try:
                response = client.models.generate_content(model='gemini-2.0-flash', contents=prompt)
                ai_output = response.text.strip()

                # Parse changes
                work_list = []
                if "Smart" in mode and "->" in ai_output:
                    for pair in ai_output.split("|"):
                        if "->" in pair:
                            o, n = pair.split("->")
                            work_list.append((o.strip(), n.strip()))
                else:
                    work_list.append((target_text, ai_output))

                # --- PDF MODIFICATION ---
                total_changes = 0
                for old_s, new_s in work_list:
                    for page in doc:
                        instances = page.search_for(old_s)
                        for inst in instances:
                            # 1. Precise Whitening
                            page.add_redact_annot(inst, fill=(1, 1, 1))
                            page.apply_redactions()
                            
                            # 2. Symmetry Insertion (The '66 to 76' Alignment Fix)
                            # inst.y1 is the bottom of the box. -2 aligns the baseline.
                            page.insert_text(
                                fitz.Point(inst.x0, inst.y1 - 2), 
                                new_s, 
                                fontsize=10, 
                                fontname="helv", 
                                color=(0, 0, 0)
                            )
                            total_changes += 1

                if total_changes > 0:
                    doc.save(out_path)
                    with open(out_path, "rb") as f:
                        st.success(f"Success! {len(work_list)} logical values updated.")
                        st.download_button("Download Edited PDF", f, file_name="smart_edit.pdf")
                else:
                    st.error(f"Could not find '{target_text}' in the file.")

            except Exception as e:
                st.error(f"Logic Error: {e}")
            
            # Cleanup
            doc.close()
            if os.path.exists(in_path): os.remove(in_path)
            if os.path.exists(out_path): os.remove(out_path)
    else:
        st.warning("Please upload a PDF and enter target text.")
